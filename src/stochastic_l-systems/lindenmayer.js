var LSystem=function(){"use strict";function t(t){var i=t[0].match(/(.+)<(.)/),s=t[0].match(/(.)>(.+)/);if(null===i&&null===s)return t;var r=void 0,o=t[1].successor||t[1].successors?t[1]:{successor:t[1]};return null!==i&&(r=i[2],o.leftCtx=i[1]),null!==s&&(r=s[1],o.rightCtx=s[2]),[r,o]}function i(t){if("string"!=typeof t&&t instanceof String==!1)return t;for(var i=[],s=t,r=Array.isArray(s),o=0,s=r?s:s[Symbol.iterator]();;){var e;if(r){if(o>=s.length)break;e=s[o++]}else{if((o=s.next()).done)break;e=o.value}var n=e;i.push({symbol:n})}return i}function s(t,r){if(t.hasOwnProperty("successors"))for(var o=0;o<t.successors.length;o++)t.successors[o]=s(t.successors[o],r);else!1===t.hasOwnProperty("successor")&&(t={successor:t});return r&&t.hasOwnProperty("successor")&&(t.successor=i(t.successor)),t}function r(t,i){return t[1]=s(t[1],i),t}function LSystem(s){var o=s.axiom,e=void 0===o?"":o,n=s.productions,a=s.finals,c=s.branchSymbols,h=void 0===c?"":c,u=s.ignoredSymbols,l=void 0===u?"":u,f=s.allowClassicSyntax,d=void 0===f||f,m=s.classicParametricSyntax,v=void 0!==m&&m,y=s.forceObjects,b=void 0!==y&&y,g=s.debug,x=void 0!==g&&g;return this.setAxiom=function(t){this.axiom=this.forceObjects?i(t):t},this.getRaw=function(){return this.axiom},this.getString=function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return"string"==typeof this.axiom?this.axiom:!0===t?this.axiom.reduce((t,i)=>{if(void 0===i.symbol)throw console.log("found:",i),new Error("L-Systems that use only objects as symbols (eg: {symbol: 'F', params: []}), cant use string symbols (eg. 'F')! Check if you always return objects in your productions and no strings.");return t+i.symbol},""):JSON.stringify(this.axiom)},this.getStringResult=this.getString,this.setProduction=function(i,s){var o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],e=[i,s];if(void 0===e)throw new Error("no production specified.");if(s.successor&&s.successors)throw new Error('You can not have both a "successor" and a "successors" field in your production!');if(!0===this.allowClassicSyntax&&(e=t(e,this.ignoredSymbols)),e=r(e,this.forceObjects),e[1].isStochastic=void 0!==e[1].successors&&e[1].successors.every(t=>void 0!==t.weight),e[1].isStochastic){e[1].weightSum=0;for(var n=e[1].successors,a=Array.isArray(n),c=0,n=a?n:n[Symbol.iterator]();;){var h;if(a){if(c>=n.length)break;h=n[c++]}else{if((c=n.next()).done)break;h=c.value}var u=h;e[1].weightSum+=u.weight}}var l=e[0];if(!0===o&&this.productions.has(l)){var f=this.productions.get(l),d=f.successor,m=f.successors;d&&!m&&(f={successors:[f]}),f.successors.push(e[1]),this.productions.set(l,f)}else this.productions.set(l,e[1])},this.setProductions=function(t){if(void 0===t)throw new Error("no production specified.");this.clearProductions();for(var i=Object.entries(t),s=Array.isArray(i),r=0,i=s?i:i[Symbol.iterator]();;){var o;if(s){if(r>=i.length)break;o=i[r++]}else{if((r=i.next()).done)break;o=r.value}var e=o,n=e[0],a=e[1];this.setProduction(n,a,!0)}},this.clearProductions=function(){this.productions=new Map},this.setFinal=function(t,i){var s=[t,i];if(void 0===s)throw new Error("no final specified.");this.finals.set(s[0],s[1])},this.setFinals=function(t){if(void 0===t)throw new Error("no finals specified.");this.finals=new Map;for(var i in t)t.hasOwnProperty(i)&&this.setFinal(i,t[i])},this.getProductionResult=function(t,i,s,r){var o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],e=void 0!==t.leftCtx||void 0!==t.rightCtx,n=!1,a=!0;if(void 0!==t.condition&&!1===t.condition({index:i,currentAxiom:this.axiom,part:s,params:r})?a=!1:e&&(void 0!==t.leftCtx&&void 0!==t.rightCtx?a=this.match({direction:"left",match:t.leftCtx,index:i,branchSymbols:"[]"}).result&&this.match({direction:"right",match:t.rightCtx,index:i,branchSymbols:"[]",ignoredSymbols:l}).result:void 0!==t.leftCtx?a=this.match({direction:"left",match:t.leftCtx,index:i,branchSymbols:"[]"}).result:void 0!==t.rightCtx&&(a=this.match({direction:"right",match:t.rightCtx,index:i,branchSymbols:"[]"}).result)),!1===a)n=!1;else if(t.successors){var c,h;t.isStochastic&&(h=Math.random()*t.weightSum,c=0);for(var u=t.successors,f=Array.isArray(u),d=0,u=f?u:u[Symbol.iterator]();;){var m;if(f){if(d>=u.length)break;m=u[d++]}else{if((d=u.next()).done)break;m=d.value}var v=m;if(!(t.isStochastic&&(c+=v.weight)<h)){var y=this.getProductionResult(v,i,s,r,!0);if(void 0!==y&&!1!==y){n=y;break}}}}else n="function"==typeof t.successor?t.successor({index:i,currentAxiom:this.axiom,part:s,params:r}):t.successor;return n||(o?n:s)},this.applyProductions=function(){for(var t="string"==typeof this.axiom?"":[],i=0,s=this.axiom,r=Array.isArray(s),o=0,s=r?s:s[Symbol.iterator]();;){var e;if(r){if(o>=s.length)break;e=s[o++]}else{if((o=s.next()).done)break;e=o.value}var n=e,a=n.symbol||n,c=n.params||[],h=n;if(this.productions.has(a)){var u=this.productions.get(a);h=this.getProductionResult(u,i,n,c)}"string"==typeof t?t+=h:h instanceof Array?Array.prototype.push.apply(t,h):t.push(h),i++}return this.axiom=t,t},this.iterate=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.iterations=t;for(var i=void 0,s=0;s<t;s++)i=this.applyProductions();return i},this.final=function(t){for(var i=0,s=this.axiom,r=Array.isArray(s),o=0,s=r?s:s[Symbol.iterator]();;){var e;if(r){if(o>=s.length)break;e=s[o++]}else{if((o=s.next()).done)break;e=o.value}var n=e,a=n;if("object"==typeof n&&n.symbol&&(a=n.symbol),this.finals.has(a)){var c=this.finals.get(a),h=typeof c;if("function"!==h)throw Error("'"+a+"' has an object for a final function. But it is __not a function__ but a "+h+"!");c({index:i,part:n},t)}i++}},this.match=function(t){var i=t.axiom_,s=t.match,r=t.ignoredSymbols,o=t.branchSymbols,e=t.index,n=t.direction,a=0,c=0;i=i||this.axiom,void 0===o&&(o=void 0!==this.branchSymbols?this.branchSymbols:[]),void 0===r&&(r=void 0!==this.ignoredSymbols?this.ignoredSymbols:[]);var h=[],u=void 0,l=void 0,f=void 0,d=void 0,m=void 0,v=void 0,y=void 0;if("right"===n){if(d=v=1,f=e+1,m=0,y=s.length,o.length>0){var b=o;u=b[0],l=b[1]}}else{if("left"!==n)throw Error(n,"is not a valid direction for matching.");if(d=v=-1,f=e-1,m=s.length-1,y=-1,o.length>0){var g=o;l=g[0],u=g[1]}}for(;f<i.length&&f>=0;f+=d){var x=i[f].symbol||i[f],p=s[m];if(x===p){if((0===a||c>0)&&(x===u?(c++,a++,m+=v):x===l?(c=Math.max(0,c-1),a=Math.max(0,a-1),0===c&&(m+=v)):(h.push(f),m+=v)),m===y)return{result:!0,matchIndices:h}}else if(x===u)a++,c>0&&c++;else if(x===l)a=Math.max(0,a-1),c>0&&(c=Math.max(0,c-1));else if((0===a||c>0&&p!==l)&&!1===r.includes(x))return{result:!1,matchIndices:h}}return{result:!1,matchIndices:h}},this.ignoredSymbols=l,this.debug=x,this.branchSymbols=h,this.allowClassicSyntax=d,this.classicParametricSyntax=v,this.forceObjects=b,this.setAxiom(e),this.clearProductions(),n&&this.setProductions(n),a&&this.setFinals(a),this}return LSystem.transformClassicStochasticProductions=function(t){return function(){for(var i=t,s=i.length,r=Math.random(),o=0;o<s;o++)if(r<=(o+1)/s)return i[o];console.error("Should have returned a result of the list, something is wrong here with the random numbers?.")}},LSystem.transformClassicCSProduction=t,LSystem.transformClassicParametricAxiom=function(t){for(var i=t.replace(/\s+/g,"").split(/[\(\)]/),s=[],r=0;r<i.length-1;r+=2){var o=i[r+1].split(",").map(Number);s.push({symbol:i[r],params:o})}},LSystem.testClassicParametricSyntax=function(t){return/\(.+\)/.test(t)},LSystem}();
